---
import '~/assets/styles/tailwind.css';

import { I18N } from 'astrowind:config';

import CommonMeta from '~/components/common/CommonMeta.astro';
import Favicons from '~/components/Favicons.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import ApplyColorMode from '~/components/common/ApplyColorMode.astro';
import Metadata from '~/components/common/Metadata.astro';
import SiteVerification from '~/components/common/SiteVerification.astro';
import Analytics from '~/components/common/Analytics.astro';
import BasicScripts from '~/components/common/BasicScripts.astro';

// Comment the line below to disable View Transitions
import { ClientRouter } from 'astro:transitions';

import type { MetaData as MetaDataType } from '~/types';

export interface Props {
  metadata?: MetaDataType;
}

const { metadata = {} } = Astro.props;
const { language, textDirection } = I18N;
---

<!doctype html>
<html lang={language} dir={textDirection} class="2xl:text-[20px]">
  <head>
    <CommonMeta />
    <Favicons />
    <CustomStyles />
    <ApplyColorMode />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <ClientRouter fallback="swap" />

    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
      crossorigin="anonymous"></script>
  </head>

  <body class="antialiased text-default bg-page tracking-tight">
    <div
      id="dummy-ad-overlay"
      style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; font-family: ui-sans-serif, system-ui, sans-serif;"
    >
      <h2 style="color: #fbbf24; font-size: 24px; font-weight: bold; letter-spacing: 2px; margin-bottom: 10px;">
        ADVERTISEMENT
      </h2>
      <p style="color: #a1a1aa; margin-bottom: 30px;">Supporting the developers...</p>

      <div style="width: 250px; height: 8px; background-color: #27272a; border-radius: 4px; overflow: hidden;">
        <div
          id="dummy-ad-progress"
          style="width: 0%; height: 100%; background-color: #fbbf24; transition: width 5s linear;"
        >
        </div>
      </div>
      <p id="dummy-ad-timer" style="color: #71717a; font-size: 14px; margin-top: 15px;">5 seconds remaining</p>
    </div>
    <slot />

    <BasicScripts />

    <script is:inline>
      window.play_interstitial_ad = function (godot_callback) {
        console.log('[Astro] Global ad function triggered!');

        const overlay = document.getElementById('dummy-ad-overlay');
        const progress = document.getElementById('dummy-ad-progress');

        if (!overlay) {
          console.error('[Astro] Ad overlay div missing!');
          if (godot_callback) godot_callback();
          return;
        }

        overlay.style.display = 'flex';
        if (progress) progress.style.width = '100%';

        // 5-second dummy timer
        setTimeout(() => {
          overlay.style.display = 'none';
          if (progress) progress.style.width = '0%';
          console.log('[Astro] Ad finished, notifying Godot.');

          // Use the 'call' method to ensure Godot's callback object is invoked properly
          if (godot_callback) {
            try {
              godot_callback();
            } catch {
              // We removed the (e) so ESLint is happy!
              console.log('[Astro] Callback handled.');
            }
          }
        }, 5000);
      };
    </script>
  </body>
</html>
